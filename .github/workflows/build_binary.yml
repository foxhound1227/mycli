name: Build MyCLI Binary

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Create Wrapper Script
      run: |
        cat > mycli_wrapper.py << 'EOF'
        #!/usr/bin/env python3
        from mycli.main import cli
        if __name__ == '__main__':
            try:
                cli()
            except Exception as e:
                print(f"Error: {e}")
                import traceback
                traceback.print_exc()
        EOF

    - name: Build in Manylinux Container
      run: |
        # Use a consistent container name
        CONTAINER_NAME="mycli_builder"
        
        # 1. Create the container (do not run yet)
        docker create --name $CONTAINER_NAME \
          quay.io/pypa/manylinux2014_x86_64 \
          bash -c "
            # Use Python 3.8 from manylinux image
            /opt/python/cp38-cp38/bin/pip install --upgrade pip
            
            # Install mycli and PyInstaller
            /opt/python/cp38-cp38/bin/pip install mycli pyinstaller 'importlib-metadata<5.0'
            
            # Build standalone executable with PyInstaller
            cd /tmp
            # Use --collect-all to grab all data files and hidden imports for mycli
            # Remove --strip for safety
            /opt/python/cp38-cp38/bin/python -m PyInstaller --onefile --clean --name mycli_linux --collect-all mycli mycli_wrapper.py
            
            # Verify the binary exists in dist folder
            ls -la /tmp/dist/mycli_linux
          "
        
        # 2. Copy the wrapper script into the container
        docker cp mycli_wrapper.py $CONTAINER_NAME:/tmp/mycli_wrapper.py
        
        # 3. Start the container and wait for it to finish
        docker start -a $CONTAINER_NAME
        
        # 4. Copy the binary out of the container (PyInstaller puts it in dist/)
        docker cp $CONTAINER_NAME:/tmp/dist/mycli_linux .
        
        # 5. Clean up
        docker rm $CONTAINER_NAME
        
        # 6. Verify file exists
        ls -la mycli_linux

    - name: Upload Binary Artifact
      uses: actions/upload-artifact@v4
      with:
        name: mycli_linux_standalone_binary
        path: mycli_linux
